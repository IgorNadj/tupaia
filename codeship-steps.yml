- name: validate-code
  service: validation
  command: "./packages/devops/scripts/ci/validateCode.sh"

- type: parallel # they're in containers, so even though they generally use one db, they're sandboxed
  name: test-backends
  services:
    - meditrak-server
    - web-config-server
  steps:
    - name: test
      command: "./packages/devops/scripts/ci/testBackend.sh"

- type: serial
  name: pull latest into ec2
  service: admin-panel # doesn't matter which, so long as we just do this group of steps once for all packages
  steps:
    - name: reinstate SSH Private Key File
      command: /bin/bash -c "echo -e $PRIVATE_SSH_KEY >> /root/.ssh/id_rsa"
    - name: chmod id_rsa
      command: chmod 600 /root/.ssh/id_rsa
    - name: pull latest and install dependencies
      command: "./packages/devops/scripts/ci/pullLatest.sh"

- type: parallel
  name: deploy-all
  steps:
    - type: parallel
      name: frontend-deploy
      services:
        - admin-panel
        - web-frontend
      steps:
        - name: deploy
          command: "./packages/devops/scripts/ci/deployFrontend.sh"

    - type: parallel
      name: backend-deploy
      services:
        - meditrak-server
        - web-config-server
      steps:
        - name: deploy
          command: "./packages/devops/scripts/ci/deployBackend.sh"
