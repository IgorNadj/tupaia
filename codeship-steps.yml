- type: parallel
  name: validate
  services:
    - meditrak-server-validation
    - web-config-server-validation
  steps:
    - name: validate
      command: './packages/devops/scripts/ci/validateCode.sh'

- type: parallel # they're in containers, so even though they generally use one db, they're sandboxed
  name: test-all
  steps:
    - name: test-meditrak-server
      service: meditrak-server-testing
      command: './packages/devops/scripts/ci/testBackend.sh'
    - name: test-web-config-server
      service: web-config-server-testing
      command: './packages/devops/scripts/ci/testBackend.sh'
    - name: test-database
      service: database-testing
      command: './packages/devops/scripts/ci/testPackage.sh'

- type: serial
  name: pull latest into ec2
  service: deployment
  steps:
    - name: reinstate SSH Private Key File
      command: /bin/bash -c "echo -e $PRIVATE_SSH_KEY >> /root/.ssh/id_rsa"
    - name: chmod id_rsa
      command: chmod 600 /root/.ssh/id_rsa
    - name: pull latest and install dependencies
      command: './packages/devops/scripts/ci/pullLatest.sh'

- type: parallel
  name: deploy-all
  service: deployment
  steps:
    - name: deploy-admin-panel
      command: './packages/devops/scripts/ci/deployFrontend.sh admin-panel'
    - name: deploy-web-frontend
      command: './packages/devops/scripts/ci/deployFrontend.sh web-frontend'
    - name: deploy-web-config-server
      command: './packages/devops/scripts/ci/deployBackend.sh web-config-server'
    - name: deploy-meditrak-server
      command: './packages/devops/scripts/ci/deployBackend.sh meditrak-server'
