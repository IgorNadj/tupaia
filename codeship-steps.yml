- type: parallel
  name: validate-code
  services:
    - meditrak-server-validation
    - web-config-server-validation
  steps:
    - name: validate
      command: './packages/devops/scripts/ci/validateCode.sh'

- type: parallel # they're in containers, so even though they generally use one db, they're sandboxed
  name: test-backends
  services:
    - meditrak-server-testing
    - web-config-server-testing
  steps:
    - name: test
      command: './packages/devops/scripts/ci/testBackend.sh'

- type: serial
  name: pull latest into ec2
  service: deployment
  steps:
    - name: reinstate SSH Private Key File
      command: /bin/bash -c "echo -e $PRIVATE_SSH_KEY >> /root/.ssh/id_rsa"
    - name: chmod id_rsa
      command: chmod 600 /root/.ssh/id_rsa
    - name: pull latest and install dependencies
      command: './packages/devops/scripts/ci/pullLatest.sh'

- type: parallel
  name: deploy-all
  service: deployment
  steps:
    - name: deploy-admin-panel
      command: 'CI_PACKAGE=admin-panel ./packages/devops/scripts/ci/deployFrontend.sh'
    - name: deploy-web-frontend
      command: 'CI_PACKAGE=web-frontend ./packages/devops/scripts/ci/deployFrontend.sh'
    - name: deploy-web-config-server
      command: 'CI_PACKAGE=web-config-server ./packages/devops/scripts/ci/deployBackend.sh'
    - name: deploy-meditrak-server
      command: 'CI_PACKAGE=meditrak-server ./packages/devops/scripts/ci/deployBackend.sh'
